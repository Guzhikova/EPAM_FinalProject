@using DentalOffice.WebUI.Management;
@using DentalOffice.Entities;
@{
    Layout = "~/Pages/Layouts/_MainLayout.cshtml";
    PageData["Title"] = "Запись на прием";

    var appManager = new AppointmentManager();
    var roleProvider = new DentalOfficeRoleProvider();


    string errorMessage = "";
    string adminInfo = "Обратитесь за помощью к администратору admin@mystom.ru";

    string dayOfWeek = "";
    Record record = null;



    DateTime currentDate = DateTime.Now;
    DateTime validDate = appManager.GetValidDate(currentDate, out dayOfWeek);
    var records = appManager.GetAllOnDate(validDate, out errorMessage);


    string disAttr = "";
    string disClass = "";
    string displayAttr = "style=display:none";


    DateTime.TryParse(Request["date"], out DateTime reqDate);

    string idAttr = "";

    if (!String.IsNullOrEmpty(Request["date"]) && !String.IsNullOrEmpty(Request["time"]))
    {
        if (Request["result"] == "success")
        {
            displayAttr = "";
            idAttr = $"d{reqDate.Day}t{Request["time"]}";
        }
        if (roleProvider.IsUserInRole(User.Identity.Name, "Пациент"))
        {
            record = appManager.CreateRecordFromRequest(Request, User.Identity.Name);
            if (record.ID != 0)
            {
                displayAttr = "";
                idAttr = $"d{reqDate.Day}t{Request["time"]}";
            }
        }
        else
        {
            Response.Redirect($"~/Pages/UnregisteredPatient?date={Request["date"]}&time={Request["time"]}");
        }

    }

}
@section AdditionalScripts
    {

    <script type="text/javascript">
        if ('@idAttr' != "")
        {
            document.getElementById('@idAttr').setAttribute('aria-disabled', 'true');
            document.getElementById('@idAttr').classList.add('disabled');
        }
    </script>
}

<div class="row">

    @if (record != null)
    {
        <div class="alert alert-success" role="alert" @displayAttr>
            Поздравляем, вы успешно записаны на прием @record.Date.ToString("f")
        </div>
    }

    @if (records != null)
    {<h5 class="text-center">Запись на приём осуществляется на ближайшие три рабочих дня. Выберите любое свободное время.</h5>

    }
    else
    {
        <div class="alert alert-danger" role="alert">
            @errorMessage. @adminInfo
        </div>
    }
</div>

@if (records != null)
{

    <div class="row">
        <div class="col-md-2"></div>

        @for (int day = 0; day < 3; day++)
        {
            <div class="col-md-3">
                @{
                    if (day > 0)
                    {

                        validDate = appManager.GetValidDate(currentDate.AddDays(day), out dayOfWeek);
                        records = appManager.GetAllOnDate(validDate, out errorMessage);
                    }
                }

                <h6>@dayOfWeek</h6>
                @validDate.ToString("D")


                @for (int i = 8; i < 18; i++)
                {
                    if (records.Any(rec => rec.Date.Hour == i))
                    {
                        disAttr = "aria-disabled=true";
                        disClass = "disabled";
                    }
                    <a href="~/Pages/MakeAppointment?date=@validDate.ToString("d")&time=@i" class="btn btn-secondary m-2 w-75 @disClass" id=@($"d{validDate.Day}t{i}") @disAttr>
                        @i:00 - @(i + 1):00
                    </a>

                    {
                        disAttr = "";
                        disClass = "";
                    }
                }

            </div>
        }
    </div>
}






